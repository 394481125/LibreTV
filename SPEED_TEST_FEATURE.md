# 一键测速功能使用指南

## 功能概述

LibreTV 现已支持**一键测速功能**，让用户在切换视频资源时，能够快速了解各资源的速度情况，从而选择最快的资源进行播放。

## 功能特性

### 1. **快速测速按钮**
- 📍 位置：播放器顶部资源信息栏（"切换资源"按钮左侧）
- 🎯 功能：一键测试当前正在播放的资源速度
- ⚡ 特点：
  - 实时显示测速结果（毫秒级）
  - 按钮加载状态提示
  - toast 提示显示测速结果

### 2. **资源速度等级指示**
切换资源时，各资源会显示速度指示器：
- 🟢 **绿色/快速**：< 1500ms（推荐）
- 🟡 **黄色/中等**：1500ms ~ 3000ms
- 🔴 **红色/慢**：> 3000ms（不推荐）
- ❌ **灰色/失败**：测速失败或无法连接

### 3. **智能资源排序**
在切换资源模态框中：
- ✅ 当前正在播放的资源显示在最前面
- 📊 其他资源按照测速结果自动排序
- ⚡ 快速资源优先显示，便于快速选择

### 4. **视觉反馈**
- 资源卡片根据速度显示不同的背景色
  - 快速资源：绿色背景
  - 中等速度：黄色背景
  - 慢速资源：红色背景
- 资源卡片右上角显示速度徽章
- 底部显示集数和响应时间

## 使用流程

### 快速测速当前资源
1. 打开任意视频播放器
2. 在顶部资源信息栏找到 **"测速"** 按钮
3. 点击按钮，开始测速
4. 等待 1-5 秒，查看 toast 提示的结果

### 切换资源并查看速度对比
1. 点击 **"切换资源"** 按钮
2. 系统自动加载资源列表并进行速度测试
3. 观察各资源的速度指示器（右上角徽章）
4. 根据速度（快-中-慢）选择最优资源
5. 点击资源卡片即可切换

## 速度测试原理

测速功能通过以下方式评估资源速度：
1. **API 响应时间**：请求视频详情 API 的响应时间
2. **视频链接响应时间**：测试第一集视频的实际加载速度
3. **总时间**：API + 视频链接响应的综合时间

## 技术细节

### 新增函数

#### `performQuickSpeedTest()`
快速测速当前资源
- 获取当前播放资源信息
- 调用 `testVideoSourceSpeed()` 进行测速
- 显示测速结果提示

#### `testVideoSourceSpeed(sourceKey, vodId)`
测试指定资源的速度（已优化）
- 参数：
  - `sourceKey`：资源标识符（支持内置和自定义API）
  - `vodId`：视频ID
- 返回：`{ speed: ms, episodes: count, error?: string }`

#### `formatSpeedDisplay(speedResult)`
格式化速度显示（已改进）
- 返回：HTML 格式的速度徽章
- 包含：图标、速度、等级、集数等信息

#### `closeModal()`
关闭资源切换模态框

### 新增 CSS 类

| 类名 | 用途 |
|------|------|
| `.speed-badge` | 速度徽章容器 |
| `.speed-indicator` | 速度指示器 |
| `.speed-indicator.good` | 快速指示器 |
| `.speed-indicator.medium` | 中等速度指示器 |
| `.speed-indicator.poor` | 慢速指示器 |
| `.speed-test-btn` | 快速测速按钮 |
| `.speed-test-progress` | 加载进度提示 |
| `.resource-card` | 资源卡片容器 |

## 浏览器兼容性

- ✅ Chrome/Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ 移动浏览器（iOS Safari, Chrome Mobile）

## 常见问题

### Q: 为什么测速结果显示为 "失败"？
A: 可能原因：
- 网络连接不稳定
- 视频源服务器无法访问
- 跨域限制（CORS 问题）
- 5 秒超时（源响应过慢）

### Q: 测速结果能否作为绝对参考？
A: 否。测速结果只反映当前时刻的网络状况，实际播放速度可能因以下因素而异：
- 用户网络质量波动
- 服务器负载变化
- 地理位置和 ISP 影响
- 时间段不同

### Q: 多长时间后应该重新测速？
A: 建议在以下情况重新测速：
- 网络环境改变
- 长时间使用（> 30分钟）
- 切换到不同的网络（WiFi/4G/5G）

## 性能指标

- 单个资源测速时间：1-5 秒
- 全部资源测速时间：取决于资源数量（通常 3-10 秒）
- 测速不影响当前播放质量
- 测速请求会使用 Cache-Busting 防止缓存干扰

## 更新日志

### v1.0 (2025-02-05)
- ✨ 初始版本
- 🎯 快速单资源测速
- 📊 资源列表自动排序
- 🎨 完整的 UI 反馈

---

**提示**：此功能完全客户端实现，不收集任何用户数据或测速信息。
